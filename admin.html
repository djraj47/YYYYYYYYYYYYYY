<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Tournament Admin - Firebase Integration</title>
    <style>
        :root {
            --purple-main: #3d46b1;
            --purple-dark: #1a1e5e;
            --alive: #00f2c3;
            --knocked: #ff4d6d;
            --dead: #444;
            --yellow: #d4d41c;
        }

        body {
            background: #0f0f1a;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: auto;
        }

        h1 {
            color: var(--purple-main);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .table-card {
            background: #161625;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #2d2d44;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            color: #aaa;
            font-size: 12px;
            text-transform: uppercase;
            padding: 12px;
            border-bottom: 2px solid #2d2d44;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #2d2d44;
            text-align: center;
        }

        input {
            background: #1e1e2f;
            color: white;
            border: 1px solid #3d3d5c;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .total-pts-box {
            cursor: pointer;
            background: var(--purple-dark);
            border: 1px solid var(--purple-main);
            color: white;
            font-weight: bold;
            padding: 6px;
            border-radius: 4px;
            display: inline-block;
            width: 55px;
        }

        .team-name-input {
            width: 140px;
            text-align: left;
            font-weight: bold;
        }

        .slot-input {
            width: 50px;
        }

        .admin-logo-preview {
            width: 40px;
            height: 40px;
            background: #1e1e2f;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed #444;
            overflow: hidden;
        }

        .admin-logo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .status-dot {
            width: 12px;
            height: 24px;
            display: inline-block;
            cursor: pointer;
            border-radius: 2px;
            margin: 0 3px;
        }

        .s1 {
            background: var(--alive);
        }

        .s2 {
            background: var(--knocked);
        }

        .s0 {
            background: var(--dead);
        }

        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .box {
            background: #161625;
            padding: 20px;
            border-radius: 12px;
            flex: 1;
            border: 1px solid #2d2d44;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 11px;
        }

        .btn-purple {
            background: var(--purple-main);
            color: white;
        }

        .btn-kill {
            background: #ff4d6d;
            color: white;
            margin-right: 5px;
        }

        .btn-grenade {
            background: #f39c12;
            color: white;
            margin-right: 5px;
        }

        .btn-dom {
            background: #9b59b6;
            color: white;
        }

        .btn-kill-all {
            background: #c0392b;
            color: white;
            margin-left: 5px;
        }

        .next-match-ui {
            display: none;
            background: #1e1e2f;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid var(--purple-main);
        }

        .show-next .next-match-ui {
            display: block;
        }

        .pos-input-cell {
            display: none;
        }

        .show-next .pos-input-cell {
            display: table-cell;
        }

        select {
            background: #1e1e2f;
            color: white;
            border: 1px solid #3d3d5c;
            padding: 8px;
            border-radius: 4px;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
        }

        .small-label {
            font-size: 11px;
            color: #ccc;
            display: block;
            margin-top: 6px;
        }
    </style>
</head>

<body id="mainBody">
    <div class="status-indicator" id="connectionStatus">
        Connecting to Firebase...
    </div>

    <div class="container">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h1>Admin Panel</h1>
            <div>
                <button class="btn" style="background:#d63031;color:white;margin-right:10px;"
                    onclick="resetAllData()">RESET TO SLOT 1-21</button>
                Match:
                <input type="number" id="matchNum" value="1" oninput="syncMatchNum(this.value)" style="width:50px;">
                <button class="btn btn-purple" onclick="toggleMatchMode()">Finish Match</button>
            </div>
        </div>

        <div class="control-row">
            <div class="box">
                <h4 style="margin:0 0 15px 0;color:var(--yellow);">LEFT POPUPS (NOTIFICATIONS)</h4>

                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
                    <input type="text" id="pName" placeholder="Player Name" style="width:120px">
                    <select id="pTeam"></select>
                </div>

                <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;">
                    <div>
                        <input type="file" id="firstKillImgInp" onchange="loadNotifImg('first')"
                            style="font-size:10px;width:180px;">
                        <span class="small-label">First Kill Image</span>
                    </div>
                    <div>
                        <input type="file" id="grenadeKillImgInp" onchange="loadNotifImg('grenade')"
                            style="font-size:10px;width:180px;">
                        <span class="small-label">Grenade Kill Image</span>
                    </div>
                    <div>
                        <input type="file" id="dominationImgInp" onchange="loadNotifImg('dom')"
                            style="font-size:10px;width:180px;">
                        <span class="small-label">Domination Image</span>
                    </div>
                </div>

                <div style="margin-top:5px;">
                    <button class="btn btn-kill" onclick="sendEvent('FIRST KILL')">First Kill</button>
                    <button class="btn btn-grenade" onclick="sendEvent('GRENADE KILL')">Grenade Kill</button>
                    <button class="btn btn-dom" onclick="sendEvent('DOMINATING')">Dominating</button>
                </div>
            </div>

            <div class="box">
                <h4 style="margin:0 0 15px 0;color:var(--alive);">FEATURED PLAYER</h4>
                <input type="file" id="featInp" onchange="loadFeat(this)" style="font-size:10px;width:150px;">
                <input type="text" id="featN" placeholder="Player Name" style="width:100px">
                <button class="btn btn-purple" onclick="sendFeat(true)">SHOW</button>
                <button class="btn" style="background:#444;color:white;" onclick="sendFeat(false)">HIDE</button>
            </div>
        </div>

        <div class="next-match-ui">
            <h3 style="margin-top:0;">End of Match Points</h3>
            <button class="btn" style="background:var(--alive);color:#000;width:100%;"
                onclick="submitAllResults()">SUBMIT RESULTS &amp; ADVANCE</button>
        </div>

        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th>Slot</th>
                        <th>Logo</th>
                        <th>Team Name</th>
                        <th>Squad Status</th>
                        <th>Total Pts</th>
                        <th>Match Elims</th>
                        <th class="pos-input-cell">Pos Pts</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="adminBody"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDAnI2pDCsxGAaARD1XGao7O3KGU-Y1uhk",
            authDomain: "productionalive-23e02.firebaseapp.com",
            projectId: "productionalive-23e02",
            storageBucket: "productionalive-23e02.firebasestorage.app",
            messagingSenderId: "954817549476",
            appId: "1:954817549476:web:2853416917fda7472f0231",
            measurementId: "G-V0JS3MWPZB",
            databaseURL: "https://productionalive-23e02-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const esportsDataRef = ref(database, "esportsData");
        const activeEventRef = ref(database, "activeEvent");
        const featuredPlayerRef = ref(database, "featuredPlayer");
        const matchNumRef = ref(database, "matchNum");

        let teams = [];
        let matchNum = 1;
        let featImg = "";
        let isConnected = false;

        // separate images for events
        let notifImages = {
            first: "",
            grenade: "",
            dom: ""
        };

        const statusEl = document.getElementById("connectionStatus");

        onValue(esportsDataRef, (snapshot) => {
            const data = snapshot.val();
            if (data) {
                teams = data;
                render();
                updateConnectionStatus(true);
            }
        });

        onValue(matchNumRef, (snapshot) => {
            const data = snapshot.val();
            if (data !== null) {
                matchNum = parseInt(data) || 1;
                document.getElementById("matchNum").value = matchNum;
            }
        });

        function updateConnectionStatus(connected) {
            isConnected = connected;
            statusEl.textContent = connected ? "‚úÖ Connected to Firebase" : "‚ùå Disconnected";
            statusEl.style.background = connected ? "rgba(0,255,0,0.2)" : "rgba(255,0,0,0.2)";
        }

        function loadTeams() {
            const defaultTeams = Array.from({ length: 21 }, (_, i) => ({
                id: "t" + i,
                slot: i + 1,
                name: `Team ${i + 1}`,
                pts: 0,
                elims: 0,
                status: [1, 1, 1, 1],
                img: null
            }));
            set(esportsDataRef, defaultTeams);
            teams = defaultTeams;
            return teams;
        }

        function render() {
            const displayData = [...teams].sort((a, b) => a.slot - b.slot);
            const body = document.getElementById("adminBody");
            const sel = document.getElementById("pTeam");
            body.innerHTML = "";
            sel.innerHTML = "";

            displayData.forEach(team => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                <td>
                    <input class="slot-input" type="number" value="${team.slot}"
                           oninput="updateSlot('${team.id}', this.value)">
                </td>
                <td>
                    <div class="admin-logo-preview" onclick="document.getElementById('f-${team.id}').click()">
                        ${team.img ? `<img src="${team.img}">` : "üìÅ"}
                    </div>
                    <input type="file" id="f-${team.id}" style="display:none"
                           onchange="uploadLogo('${team.id}', this)">
                </td>
                <td>
                    <input class="team-name-input"
                           value="${team.name}"
                           oninput="updateField('${team.id}','name',this.value)">
                </td>
                <td>
                    ${team.status.map((s, si) =>
                    `<div class="status-dot s${s}" onclick="cycleStatus('${team.id}',${si})"></div>`
                ).join("")}
                </td>
                <td><div class="total-pts-box" onclick="manualEditPts('${team.id}')">${team.pts}</div></td>
                <td><input type="number" value="${team.elims}"
                           oninput="updateField('${team.id}','elims',this.value)" style="width:50px;"></td>
                <td class="pos-input-cell">
                    <input type="number" class="pos-pts-val" data-tid="${team.id}" value="0" style="width:50px;">
                </td>
                <td>
                    <button class="btn btn-kill-all" onclick="killAllAlive('${team.id}')">Kill All Alive</button>
                </td>
            `;
                body.appendChild(tr);
                sel.innerHTML += `<option value="${team.id}">Slot ${team.slot} - ${team.name}</option>`;
            });
        }

        window.resetAllData = function () {
            if (confirm("This will wipe all team names and scores and reset to Slot 1-21. Continue?")) {
                loadTeams();
            }
        };

        window.uploadLogo = function (id, input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const idx = teams.findIndex(t => t.id === id);
                if (idx !== -1) {
                    teams[idx].img = e.target.result;
                    set(esportsDataRef, teams);
                }
                render();
            };
            if (input.files[0]) reader.readAsDataURL(input.files[0]);
        };

        window.loadFeat = function (input) {
            const reader = new FileReader();
            reader.onload = (e) => { featImg = e.target.result; };
            if (input.files[0]) reader.readAsDataURL(input.files[0]);
        };

        // Load images for different notif types
        window.loadNotifImg = function (type) {
            let inputId = "";
            if (type === "first") inputId = "firstKillImgInp";
            else if (type === "grenade") inputId = "grenadeKillImgInp";
            else if (type === "dom") inputId = "dominationImgInp";

            const input = document.getElementById(inputId);
            if (!input || !input.files[0]) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                notifImages[type] = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        };

        window.sendEvent = function (type) {
            const teamId = document.getElementById("pTeam").value;
            const team = teams.find(t => t.id === teamId);
            if (!team) return;

            let customImg = "";
            if (type === "FIRST KILL") customImg = notifImages.first;
            else if (type === "GRENADE KILL") customImg = notifImages.grenade;
            else if (type === "DOMINATING") customImg = notifImages.dom;

            set(activeEventRef, {
                type,
                player: document.getElementById("pName").value,
                logo: team.img,
                customImg,
                ts: Date.now()
            });
        };

        window.sendFeat = function (active) {
            const teamId = document.getElementById("pTeam").value;
            const team = teams.find(t => t.id === teamId);
            set(featuredPlayerRef, {
                active,
                name: document.getElementById("featN").value,
                team: team ? team.name : "",
                img: featImg,
                ts: Date.now()
            });
        };

        window.updateField = function (id, field, val) {
            const idx = teams.findIndex(t => t.id === id);
            if (idx === -1) return;
            teams[idx][field] = field === "name" ? val : parseInt(val || 0);
            set(esportsDataRef, teams);
        };

        // Change slot number
        window.updateSlot = function (id, val) {
            const idx = teams.findIndex(t => t.id === id);
            if (idx === -1) return;
            teams[idx].slot = parseInt(val || 0);
            set(esportsDataRef, teams);
            render();
        };

        // Kill all alive players in a team
        window.killAllAlive = function (id) {
            const idx = teams.findIndex(t => t.id === id);
            if (idx === -1) return;
            const statusArr = teams[idx].status;
            teams[idx].status = statusArr.map(s => (s > 0 ? 0 : s));
            set(esportsDataRef, teams);
            render();
        };

        window.cycleStatus = function (id, si) {
            const idx = teams.findIndex(t => t.id === id);
            if (idx === -1) return;
            teams[idx].status[si] = (teams[idx].status[si] + 1) % 3;
            set(esportsDataRef, teams);
            render();
        };

        window.manualEditPts = function (id) {
            const idx = teams.findIndex(t => t.id === id);
            if (idx === -1) return;
            const n = prompt("Edit Points:", teams[idx].pts);
            if (n !== null) {
                teams[idx].pts = parseInt(n) || 0;
                set(esportsDataRef, teams);
                render();
            }
        };

        window.toggleMatchMode = function () {
            document.getElementById("mainBody").classList.toggle("show-next");
        };

        window.syncMatchNum = function (val) {
            matchNum = parseInt(val) || 1;
            set(matchNumRef, matchNum);
        };

        window.submitAllResults = function () {
            document.querySelectorAll(".pos-pts-val").forEach(inp => {
                const idx = teams.findIndex(x => x.id === inp.dataset.tid);
                if (idx !== -1) {
                    teams[idx].pts += (teams[idx].elims + parseInt(inp.value || 0));
                    teams[idx].elims = 0;
                    teams[idx].status = [1, 1, 1, 1];
                }
            });

            matchNum = parseInt(document.getElementById("matchNum").value);
            document.getElementById("matchNum").value = matchNum + 1;
            syncMatchNum(matchNum + 1);
            toggleMatchMode();
            set(esportsDataRef, teams);
        };

        function init() {
            onValue(esportsDataRef, (snapshot) => {
                if (!snapshot.exists()) {
                    loadTeams();
                }
            }, { onlyOnce: true });
        }

        init();
        updateConnectionStatus(false);
    </script>
</body>

</html>
