<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Tournament Admin - Secure</title>
    <style>
        :root {
            --purple-main: #3d46b1;
            --purple-dark: #1a1e5e;
            --alive: #00f2c3;
            --knocked: #ff4d6d;
            --dead: #444;
            --yellow: #d4d41c;
        }

        body {
            background: #0f0f1a;
            color: white;
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 1100px;
            margin: auto;
        }

        h1 {
            color: var(--purple-main);
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .table-card {
            background: #161625;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #2d2d44;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            color: #aaa;
            font-size: 12px;
            text-transform: uppercase;
            padding: 12px;
            border-bottom: 2px solid #2d2d44;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #2d2d44;
            text-align: center;
        }

        input {
            background: #1e1e2f;
            color: white;
            border: 1px solid #3d3d5c;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
        }

        .total-pts-box {
            cursor: pointer;
            background: var(--purple-dark);
            border: 1px solid var(--purple-main);
            color: white;
            font-weight: bold;
            padding: 6px;
            border-radius: 4px;
            display: inline-block;
            width: 55px;
        }

        .team-name-input {
            width: 140px;
            text-align: left;
            font-weight: bold;
        }

        .slot-input {
            width: 50px;
        }

        .admin-logo-preview {
            width: 40px;
            height: 40px;
            background: #1e1e2f;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px dashed #444;
            overflow: hidden;
        }

        .admin-logo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .status-dot {
            width: 12px;
            height: 24px;
            display: inline-block;
            cursor: pointer;
            border-radius: 2px;
            margin: 0 3px;
        }

        .s1 {
            background: var(--alive);
        }

        .s2 {
            background: var(--knocked);
        }

        .s0 {
            background: var(--dead);
        }

        .control-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .box {
            background: #161625;
            padding: 20px;
            border-radius: 12px;
            flex: 1;
            border: 1px solid #2d2d44;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 11px;
        }

        .btn-purple {
            background: var(--purple-main);
            color: white;
        }

        .btn-kill {
            background: #ff4d6d;
            color: white;
            margin-right: 5px;
        }

        .btn-grenade {
            background: #f39c12;
            color: white;
            margin-right: 5px;
        }

        .btn-dom {
            background: #9b59b6;
            color: white;
        }

        .btn-kill-all {
            background: #c0392b;
            color: white;
            margin-left: 5px;
        }

        .next-match-ui {
            display: none;
            background: #1e1e2f;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid var(--purple-main);
        }

        .show-next .next-match-ui {
            display: block;
        }

        .pos-input-cell {
            display: none;
        }

        .show-next .pos-input-cell {
            display: table-cell;
        }

        select {
            background: #1e1e2f;
            color: white;
            border: 1px solid #3d3d5c;
            padding: 8px;
            border-radius: 4px;
        }

        .status-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
        }

        .small-label {
            font-size: 11px;
            color: #ccc;
            display: block;
            margin-top: 6px;
        }

        .toggle-row {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .toggle-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: #ccc;
            cursor: pointer;
        }

        .toggle-checkbox {
            display: none;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #333;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
            flex-shrink: 0;
        }

        .toggle-switch::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 18px;
            height: 18px;
            background: #666;
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .toggle-label:has(.toggle-checkbox:checked) .toggle-switch {
            background: var(--purple-main);
        }

        .toggle-label:has(.toggle-checkbox:checked) .toggle-switch::before {
            transform: translateX(20px);
            background: white;
        }

        @supports not selector(:has) {
            .toggle-checkbox:checked~.toggle-switch {
                background: var(--purple-main);
            }

            .toggle-checkbox:checked~.toggle-switch::before {
                transform: translateX(20px);
                background: white;
            }
        }
    </style>
</head>

<body id="mainBody">
    <div class="status-indicator" id="connectionStatus">
        Connecting to Firebase...
    </div>

    <!-- GOOGLE AUTH PANEL -->
    <div id="authPanel"
        style="margin:20px auto;padding:25px;background:#161625;border-radius:12px;max-width:450px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.5);border:1px solid #2d2d44;">
        <h3 style="color:var(--purple-main);margin:0 0 20px 0;">Admin Login</h3>

        <div id="authUserInfo" style="margin-bottom:20px;font-size:14px;color:var(--alive);display:none;">
            <img id="authAvatar" src=""
                style="width:45px;height:45px;border-radius:50%;margin-right:12px;border:2px solid var(--alive);">
            <div>
                <strong id="authEmail"></strong>
                <br><small style="color:#aaa;">Google Account Verified</small>
            </div>
            <button id="logoutBtn" class="btn"
                style="background:#ff4d6d;color:white;margin-left:15px;font-size:11px;padding:8px 15px;">Logout</button>
        </div>

        <button id="googleSignInBtn" class="btn btn-purple"
            style="width:100%;padding:15px 25px;font-size:16px;font-weight:bold;box-shadow:0 4px 15px rgba(61,70,177,0.4);">
            Sign in with Google
        </button>

        <div style="margin-top:15px;padding-top:15px;border-top:1px solid #2d2d44;">
            <small style="color:#aaa;font-size:12px;">Only the owner admin account can access this panel</small>
        </div>
    </div>

    <!-- MAIN ADMIN PANEL - HIDDEN UNTIL ADMIN EMAIL LOGGED IN -->
    <div class="container" style="display:none;">
        <div class="toggle-row">
            <label class="toggle-label">
                <input type="checkbox" id="toggleOverlayLeftPopups" class="toggle-checkbox" checked>
                <span class="toggle-switch"></span>
                <span>Overlay Left Popups</span>
            </label>

            <label class="toggle-label">
                <input type="checkbox" id="toggleOverlayFeatured" class="toggle-checkbox" checked>
                <span class="toggle-switch"></span>
                <span>Overlay Featured Player</span>
            </label>

            <label class="toggle-label">
                <input type="checkbox" id="toggleOverlayElims" class="toggle-checkbox" checked>
                <span class="toggle-switch"></span>
                <span>Overlay Elim Popups</span>
            </label>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h1>Admin Panel</h1>
            <div>
                <button class="btn" style="background:#d63031;color:white;margin-right:10px;"
                    onclick="resetAllData()">RESET TO SLOT 1-21</button>
                Match:
                <input type="number" id="matchNum" value="1" oninput="syncMatchNum(this.value)" style="width:50px;">
                <button class="btn btn-purple" onclick="toggleMatchMode()">Finish Match</button>
            </div>
        </div>

        <div class="control-row">
            <div class="box" id="leftPopupsBox">
                <h4 style="margin:0 0 15px 0;color:var(--yellow);">LEFT POPUPS (NOTIFICATIONS)</h4>

                <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
                    <input type="text" id="pName" placeholder="Player Name" style="width:120px">
                    <select id="pTeam"></select>
                </div>

                <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:10px;">
                    <div>
                        <input type="file" id="firstKillImgInp" onchange="loadNotifImg('first')"
                            style="font-size:10px;width:180px;">
                        <span class="small-label">First Kill Image</span>
                    </div>
                    <div>
                        <input type="file" id="grenadeKillImgInp" onchange="loadNotifImg('grenade')"
                            style="font-size:10px;width:180px;">
                        <span class="small-label">Grenade Kill Image</span>
                    </div>
                    <div>
                        <input type="file" id="dominationImgInp" onchange="loadNotifImg('dom')"
                            style="font-size:10px;width:180px;">
                        <span class="small-label">Domination Image</span>
                    </div>
                </div>

                <div style="margin-top:5px;">
                    <button class="btn btn-kill" onclick="sendEvent('FIRST KILL')">First Kill</button>
                    <button class="btn btn-grenade" onclick="sendEvent('GRENADE KILL')">Grenade Kill</button>
                    <button class="btn btn-dom" onclick="sendEvent('DOMINATING')">Dominating</button>
                </div>
            </div>

            <div class="box" id="featuredBox">
                <h4 style="margin:0 0 15px 0;color:var(--alive);">FEATURED PLAYER</h4>
                <input type="file" id="featInp" onchange="loadFeat(this)" style="font-size:10px;width:150px;">
                <input type="text" id="featN" placeholder="Player Name" style="width:100px">
                <button class="btn btn-purple" onclick="sendFeat(true)">SHOW</button>
                <button class="btn" style="background:#444;color:white;" onclick="sendFeat(false)">HIDE</button>
            </div>
        </div>

        <div class="next-match-ui">
            <h3 style="margin-top:0;">End of Match Points</h3>
            <button class="btn" style="background:var(--alive);color:#000;width:100%;"
                onclick="submitAllResults()">SUBMIT RESULTS & ADVANCE</button>
        </div>

        <div class="table-card">
            <table>
                <thead>
                    <tr>
                        <th>Slot</th>
                        <th>Logo</th>
                        <th>Team Name</th>
                        <th>Squad Status</th>
                        <th>Total Pts</th>
                        <th>Match Elims</th>
                        <th class="pos-input-cell">Pos Pts</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="adminBody"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";
        import {
            getAuth,
            onAuthStateChanged,
            signInWithPopup,
            GoogleAuthProvider,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDAnI2pDCsxGAaARD1XGao7O3KGU-Y1uhk",
            authDomain: "productionalive-23e02.firebaseapp.com",
            projectId: "productionalive-23e02",
            storageBucket: "productionalive-23e02.firebasestorage.app",
            messagingSenderId: "954817549476",
            appId: "1:954817549476:web:2853416917fda7472f0231",
            measurementId: "G-V0JS3MWPZB",
            databaseURL: "https://productionalive-23e02-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const ADMIN_EMAIL = "rajnimcet@gmail.com";

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const auth = getAuth(app);

        const esportsDataRef = ref(database, "esportsData");
        const activeEventRef = ref(database, "activeEvent");
        const featuredPlayerRef = ref(database, "featuredPlayer");
        const matchNumRef = ref(database, "matchNum");
        const overlayTogglesRef = ref(database, "overlayToggles");

        let teams = [];
        let matchNum = 1;
        let featImg = "";
        let isConnected = false;
        let overlayToggles = { leftPopups: true, featuredPlayer: true, elimPopup: true };
        let notifImages = { first: "", grenade: "", dom: "" };

        const statusEl = document.getElementById("connectionStatus");
        const authPanel = document.getElementById("authPanel");
        const container = document.querySelector(".container");
        const googleSignInBtn = document.getElementById("googleSignInBtn");
        const authUserInfo = document.getElementById("authUserInfo");
        const authEmailSpan = document.getElementById("authEmail");
        const authAvatar = document.getElementById("authAvatar");
        const logoutBtn = document.getElementById("logoutBtn");

        const googleProvider = new GoogleAuthProvider();

        googleSignInBtn.addEventListener("click", async () => {
            try {
                googleSignInBtn.textContent = "Signing in...";
                googleSignInBtn.disabled = true;
                await signInWithPopup(auth, googleProvider);
            } catch (error) {
                alert("Google sign-in failed: " + error.message);
                googleSignInBtn.textContent = "Sign in with Google";
                googleSignInBtn.disabled = false;
            }
        });

        logoutBtn.addEventListener("click", async () => {
            await signOut(auth);
        });

        onAuthStateChanged(auth, (user) => {
            if (user && user.email === ADMIN_EMAIL) {
                authUserInfo.style.display = "block";
                authEmailSpan.textContent = user.email;
                if (user.photoURL) {
                    authAvatar.src = user.photoURL;
                    authAvatar.style.display = "inline-block";
                }

                authPanel.style.display = "none";
                container.style.display = "block";

                statusEl.textContent = "Connected & Authenticated (ADMIN)";
                statusEl.style.background = "rgba(0,255,0,0.2)";
                isConnected = true;

                startDataListeners();
            } else if (user && user.email !== ADMIN_EMAIL) {
                alert("This Google account is not allowed to access the admin panel.");
                signOut(auth);
                container.style.display = "none";
                authPanel.style.display = "block";
                statusEl.textContent = "Only the admin account can access this panel";
                statusEl.style.background = "rgba(255,0,0,0.3)";
            } else {
                authUserInfo.style.display = "none";
                authAvatar.style.display = "none";
                container.style.display = "none";
                authPanel.style.display = "block";
                googleSignInBtn.textContent = "Sign in with Google";
                googleSignInBtn.disabled = false;

                statusEl.textContent = "Please sign in with Google";
                statusEl.style.background = "rgba(255,193,7,0.3)";
                isConnected = false;
            }
        });

        function startDataListeners() {
            onValue(overlayTogglesRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    overlayToggles = data;
                    updateToggleUI();
                }
            });

            onValue(esportsDataRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    teams = data;
                    render();
                } else {
                    loadTeams();
                }
            });

            onValue(matchNumRef, (snapshot) => {
                const data = snapshot.val();
                if (data !== null) {
                    matchNum = parseInt(data) || 1;
                    document.getElementById("matchNum").value = matchNum;
                }
            });
        }

        function updateToggleUI() {
            const leftCB = document.getElementById("toggleOverlayLeftPopups");
            const featCB = document.getElementById("toggleOverlayFeatured");
            const elimCB = document.getElementById("toggleOverlayElims");
            if (leftCB) leftCB.checked = overlayToggles.leftPopups;
            if (featCB) featCB.checked = overlayToggles.featuredPlayer;
            if (elimCB) elimCB.checked = overlayToggles.elimPopup;
        }

        window.setOverlayToggle = function (type, enabled) {
            overlayToggles[type] = enabled;
            set(overlayTogglesRef, overlayToggles);
        };

        document.addEventListener('DOMContentLoaded', function () {
            const leftToggle = document.getElementById("toggleOverlayLeftPopups");
            const featuredToggle = document.getElementById("toggleOverlayFeatured");
            const elimToggle = document.getElementById("toggleOverlayElims");

            if (leftToggle) {
                leftToggle.addEventListener('change', function () {
                    setOverlayToggle('leftPopups', this.checked);
                });
            }
            if (featuredToggle) {
                featuredToggle.addEventListener('change', function () {
                    setOverlayToggle('featuredPlayer', this.checked);
                });
            }
            if (elimToggle) {
                elimToggle.addEventListener('change', function () {
                    setOverlayToggle('elimPopup', this.checked);
                });
            }
        });

        function render() {
            const displayData = [...teams].sort((a, b) => a.slot - b.slot);
            const body = document.getElementById("adminBody");
            const sel = document.getElementById("pTeam");
            body.innerHTML = "";
            sel.innerHTML = "";

            displayData.forEach(team => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
        <td>
          <input class="slot-input" type="number" value="${team.slot}"
                 oninput="updateSlot('${team.id}', this.value)">
        </td>
        <td>
          <div class="admin-logo-preview" onclick="document.getElementById('f-${team.id}').click()">
            ${team.img ? `<img src="${team.img}">` : "üìÅ"}
          </div>
          <input type="file" id="f-${team.id}" style="display:none"
                 onchange="uploadLogo('${team.id}', this)">
        </td>
        <td>
          <input class="team-name-input"
                 value="${team.name}"
                 oninput="updateField('${team.id}','name',this.value)">
        </td>
        <td>
          ${team.status.map((s, si) =>
                    `<div class="status-dot s${s}" onclick="cycleStatus('${team.id}',${si})"></div>`
                ).join("")}
        </td>
        <td><div class="total-pts-box" onclick="manualEditPts('${team.id}')">${team.pts}</div></td>
        <td><input type="number" value="${team.elims}"
                   oninput="updateField('${team.id}','elims',this.value)" style="width:50px;"></td>
        <td class="pos-input-cell">
          <input type="number" class="pos-pts-val" data-tid="${team.id}" value="0" style="width:50px;">
        </td>
        <td>
          <button class="btn btn-kill-all" onclick="killAllAlive('${team.id}')">Kill All Alive</button>
        </td>
      `;
                body.appendChild(tr);
                sel.innerHTML += `<option value="${team.id}">Slot ${team.slot} - ${team.name}</option>`;
            });
        }

        function loadTeams() {
            const defaultTeams = Array.from({ length: 21 }, (_, i) => ({
                id: "t" + i,
                slot: i + 1,
                name: `Team ${i + 1}`,
                pts: 0,
                elims: 0,
                status: [1, 1, 1, 1],
                img: null
            }));
            set(esportsDataRef, defaultTeams);
            teams = defaultTeams;
            return teams;
        }

        window.resetAllData = function () {
            if (confirm("This will wipe all team names and scores and reset to Slot 1-21. Continue?")) {
                loadTeams();
            }
        };

        window.uploadLogo = function (id, input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const idx = teams.findIndex(t => t.id === id);
                if (idx !== -1) {
                    teams[idx].img = e.target.result;
                    set(esportsDataRef, teams);
                }
                render();
            };
            if (input.files[0]) reader.readAsDataURL(input.files[0]);
        };

        window.loadFeat = function (input) {
            const reader = new FileReader();
            reader.onload = (e) => { featImg = e.target.result; };
            if (input.files[0]) reader.readAsDataURL(input.files[0]);
        };

        window.loadNotifImg = function (type) {
            let inputId = "";
            if (type === "first") inputId = "firstKillImgInp";
            else if (type === "grenade") inputId = "grenadeKillImgInp";
            else if (type === "dom") inputId = "dominationImgInp";

            const input = document.getElementById(inputId);
            if (!input || !input.files[0]) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                notifImages[type] = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        };

        // FIXED sendEvent with logging
        window.sendEvent = function (type) {
            const teamId = document.getElementById("pTeam").value;
            const team = teams.find(t => t.id === teamId);
            if (!team) {
                alert("No team selected for popup.");
                return;
            }

            let customImg = "";
            if (type === "FIRST KILL") customImg = notifImages.first;
            else if (type === "GRENADE KILL") customImg = notifImages.grenade;
            else if (type === "DOMINATING") customImg = notifImages.dom;

            const payload = {
                type,
                player: document.getElementById("pName").value || "",
                logo: team.img || "",
                customImg,
                ts: Date.now()
            };

            console.log("Sending activeEvent:", payload);
            set(activeEventRef, payload)
                .then(() => console.log("activeEvent written OK"))
                .catch(err => {
                    console.error("activeEvent write error:", err);
                    alert("Error writing popup to Firebase: " + err.message);
                });
        };

        window.sendFeat = function (active) {
            const teamId = document.getElementById("pTeam").value;
            const team = teams.find(t => t.id === teamId);
            set(featuredPlayerRef, {
                active,
                name: document.getElementById("featN").value,
                team: team ? team.name : "",
                img: featImg,
                ts: Date.now()
            });
        };

        window.updateField = function (id, field, val) {
            const idx = teams.findIndex(t => t.id === id);
            if (idx === -1) return;
            teams[idx][field] = field === "name" ? val : parseInt(val || 0);
            set(esportsDataRef, teams);
        };

        window.updateSlot = function (id, val) {
            const idx = teams.findIndex(t => t.id === id);
            if (idx === -1) return;
            teams[idx].slot = parseInt(val || 0);
            set(esportsDataRef, teams);
            render();
        };

        window.killAllAlive = function (id) {
            const idx = teams.findIndex(t => t.id === id);
            if (idx === -1) return;
            const statusArr = teams[idx].status;
            teams[idx].status = statusArr.map(s => (s > 0 ? 0 : s));
            set(esportsDataRef, teams);
            render();
        };

        window.cycleStatus = function (id, si) {
            const idx = teams.findIndex(t => t.id === id);
            if (idx === -1) return;
            teams[idx].status[si] = (teams[idx].status[si] + 1) % 3;
            set(esportsDataRef, teams);
            render();
        };

        window.manualEditPts = function (id) {
            const idx = teams.findIndex(t => t.id === id);
            if (idx === -1) return;
            const n = prompt("Edit Points:", teams[idx].pts);
            if (n !== null) {
                teams[idx].pts = parseInt(n) || 0;
                set(esportsDataRef, teams);
                render();
            }
        };

        window.toggleMatchMode = function () {
            document.getElementById("mainBody").classList.toggle("show-next");
        };

        window.syncMatchNum = function (val) {
            matchNum = parseInt(val) || 1;
            set(matchNumRef, matchNum);
        };

        window.submitAllResults = function () {
            document.querySelectorAll(".pos-pts-val").forEach(inp => {
                const idx = teams.findIndex(x => x.id === inp.dataset.tid);
                if (idx !== -1) {
                    teams[idx].pts += (teams[idx].elims + parseInt(inp.value || 0));
                    teams[idx].elims = 0;
                    teams[idx].status = [1, 1, 1, 1];
                }
            });

            matchNum = parseInt(document.getElementById("matchNum").value);
            document.getElementById("matchNum").value = matchNum + 1;
            syncMatchNum(matchNum + 1);
            toggleMatchMode();
            set(esportsDataRef, teams);
        };

        function init() {
            container.style.display = "none";
        }
        init();
    </script>

</body>

</html>
